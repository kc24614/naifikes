<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>StreamVault Ultra V8.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { background-color: #000; color: white; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; margin: 0; overflow: hidden; }
        
        /* 基礎頁面結構 */
        .page { display: none; height: 100vh; overflow-y: auto; padding-bottom: 100px; }
        .page.active { display: block; }
        
        /* 底部導航欄 */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-bottom)); background: rgba(0,0,0,0.95); backdrop-filter: blur(30px); border-top: 1px solid #111; z-index: 1000; display: flex; padding-bottom: var(--safe-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; font-size: 10px; font-weight: bold; transition: color 0.3s; }
        .nav-item.active { color: white; }

        /* 詳情內頁與靈敏手勢 */
        #detailView { position: fixed; inset: 0; z-index: 1100; display: none; background: #000; overflow-y: auto; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1); will-change: transform; }
        #detailHero { width: 100%; aspect-ratio: 16 / 10; background-size: cover; background-position: center; position: relative; }
        #detailHero::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 30%, #000 100%); }

        /* 隨機區 (TikTok 模式) */
        #randomPage { scroll-snap-type: y mandatory; overflow-y: scroll; height: 100vh; }
        .tiktok-card { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .tiktok-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: blur(50px) brightness(0.2); transform: scale(1.2); }
        
        /* Story 進度條 */
        .story-progress { position: absolute; top: calc(15px + var(--safe-top)); left: 10px; right: 10px; display: flex; gap: 4px; z-index: 50; }
        .story-bar { height: 2px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .story-fill { height: 100%; background: #fff; width: 0%; transition: width 0.2s; }

        /* 篩選與橫向滾動 */
        .filter-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid #111; cursor: pointer; }
        .filter-content { display: none; flex-wrap: wrap; gap: 8px; padding: 15px 0; }
        .filter-content.open { display: flex; }
        .chip { padding: 7px 16px; background: #0a0a0a; border-radius: 20px; font-size: 11px; border: 1px solid #1a1a1a; color: #555; }
        .chip.active { background: #fff; color: #000; border-color: #fff; }
        .row-container { display: flex; overflow-x: auto; gap: 12px; padding: 0 20px; scrollbar-width: none; }
        .row-container::-webkit-scrollbar { display: none; }

        /* 燈箱 */
        #lightbox { position: fixed; inset: 0; z-index: 2000; background: #000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <div id="lightbox">
        <div class="story-progress" id="lbProgress"></div>
        <div class="absolute inset-0 flex">
            <div class="w-1/3 h-full z-[2010]" onclick="prevLbImage()"></div>
            <div class="w-1/3 h-full z-[2010]" onclick="closeLightbox()"></div>
            <div class="w-1/3 h-full z-[2010]" onclick="nextLbImage()"></div>
        </div>
        <img id="lightboxImg" src="">
    </div>

    <div id="homePage" class="page active">
        <div id="hero" class="relative h-[72vh] flex flex-col justify-end items-center overflow-hidden">
            <div id="heroBlurBg" class="absolute inset-0 bg-cover bg-center filter blur-3xl brightness-[0.3]"></div>
            <img id="heroMainImg" src="" class="relative z-10 w-2/3 max-w-[240px] rounded-2xl shadow-2xl border border-white/10 mb-8 transition-transform duration-700">
            <div class="relative z-10 text-center pb-12 w-full px-6">
                <h1 id="heroTitle" class="text-3xl font-black italic mb-6 tracking-tighter">SV-ULTRA</h1>
                <button id="heroInfoBtn" class="bg-white text-black px-12 py-3 rounded-full font-bold text-sm active:scale-90 transition-transform">View Detail</button>
            </div>
        </div>
        <main id="mainRows" class="space-y-12 pt-8 pb-32"></main>
    </div>

    <div id="randomPage" class="page no-scrollbar"></div>

    <div id="filterPage" class="page pt-20 px-6">
        <h2 class="text-3xl font-black italic mb-8 uppercase tracking-tighter">Explore</h2>
        <div class="mb-4"><div class="filter-header" onclick="toggleCollapse('actorList')"><span class="text-xs font-black text-zinc-600 uppercase">Actors</span><i class="fa-solid fa-chevron-down text-[10px]"></i></div><div id="actorList" class="filter-content"></div></div>
        <div class="mb-8"><div class="filter-header" onclick="toggleCollapse('tagList')"><span class="text-xs font-black text-zinc-600 uppercase">Tags</span><i class="fa-solid fa-chevron-down text-[10px]"></i></div><div id="tagList" class="filter-content"></div></div>
        <div id="filterResults" class="grid grid-cols-2 gap-4 pb-40"></div>
    </div>

    <div id="userPage" class="page pt-24 px-8">
        <div class="space-y-4">
            <button onclick="document.getElementById('txtInput').click()" class="w-full py-5 bg-zinc-900 rounded-2xl font-bold border border-white/5">1. Load Path (.txt)</button>
            <input type="file" id="txtInput" accept=".txt" class="hidden">
            <button onclick="document.getElementById('folderInput').click()" class="w-full py-5 bg-blue-700 rounded-2xl font-bold">2. Select Image Folder</button>
            <input type="file" id="folderInput" webkitdirectory directory multiple class="hidden">
            <button onclick="resetDB()" class="w-full text-zinc-800 text-[10px] font-black pt-40 tracking-widest text-center uppercase">Factory Reset</button>
        </div>
    </div>

    <div id="detailView">
        <div id="detailHero"></div>
        <div class="p-6 relative">
            <div class="absolute -top-12 left-6"><h2 id="detailTitle" class="text-4xl font-black italic tracking-tighter drop-shadow-2xl"></h2></div>
            <p id="detailActor" class="text-blue-500 font-bold mb-6 text-sm pt-4"></p>
            <a id="detailPlayLink" target="_blank" class="block w-full bg-white text-black py-4 rounded-xl font-black text-center text-xs tracking-[0.2em] mb-8">WEB SEARCH</a>
            <div id="detailTags" class="flex flex-wrap gap-2 mb-10"></div>
            <div id="episodeGrid" class="grid grid-cols-2 gap-2 pb-40"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="switchPage('home')" class="nav-item active" id="navHome"><i class="fa-solid fa-house mb-1 text-lg"></i><span>Home</span></div>
        <div onclick="switchPage('random')" class="nav-item" id="navRandom"><i class="fa-solid fa-play-circle mb-1 text-lg"></i><span>Shuffle</span></div>
        <div onclick="switchPage('filter')" class="nav-item" id="navFilter"><i class="fa-solid fa-magnifying-glass mb-1 text-lg"></i><span>Filter</span></div>
        <div onclick="switchPage('user')" class="nav-item" id="navUser"><i class="fa-solid fa-database mb-1 text-lg"></i><span>Data</span></div>
    </nav>

    <script>
        let albums = {}, db, pathTable = [], randomStates = {};
        let lbCurrentList = [], lbIndex = 0;
        const DB_NAME = "StreamVault_V8_4", STORE_NAME = "albums";

        // --- 靈敏手勢優化 ---
        let startY = 0, currentY = 0, isDragging = false, startTime = 0;
        const dv = document.getElementById('detailView');
        dv.addEventListener('touchstart', (e) => { if (dv.scrollTop <= 0) { startY = e.touches[0].clientY; startTime = Date.now(); isDragging = true; dv.style.transition = 'none'; } }, { passive: true });
        dv.addEventListener('touchmove', (e) => { if (!isDragging) return; currentY = e.touches[0].clientY - startY; if (currentY > 0) { dv.style.transform = `translateY(${currentY}px)`; if (e.cancelable) e.preventDefault(); } else { isDragging = false; dv.style.transform = 'translateY(0px)'; } }, { passive: false });
        dv.addEventListener('touchend', () => { if (!isDragging) return; isDragging = false; const dur = Date.now() - startTime; const vel = currentY / dur; dv.style.transition = 'transform 0.35s cubic-bezier(0.32, 0.72, 0, 1)'; if (currentY > 80 || (vel > 0.5 && currentY > 30)) closeDetail(); else dv.style.transform = 'translateY(0px)'; currentY = 0; });

        // --- 燈箱與其它控制 ---
        function openLightbox(url, list) { lbCurrentList = list; lbIndex = list.findIndex(img => img.url === url); updateLightboxUI(); const lb = document.getElementById('lightbox'); lb.style.display = 'flex'; setTimeout(() => lb.style.opacity = 1, 10); }
        function nextLbImage() { lbIndex = (lbIndex + 1) % lbCurrentList.length; updateLightboxUI(); }
        function prevLbImage() { lbIndex = (lbIndex - 1 + lbCurrentList.length) % lbCurrentList.length; updateLightboxUI(); }
        function updateLightboxUI() { document.getElementById('lightboxImg').src = lbCurrentList[lbIndex].url; document.getElementById('lbProgress').innerHTML = lbCurrentList.map((_, i) => `<div class="story-bar"><div class="story-fill" style="width: ${i <= lbIndex ? '100%' : '0%'}"></div></div>`).join(''); }
        function closeLightbox() { const lb = document.getElementById('lightbox'); lb.style.opacity = 0; setTimeout(() => lb.style.display = 'none', 300); }

        // --- 資料庫初始化 ---
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME, {keyPath:"id"});
        req.onsuccess = e => { db = e.target.result; loadDB(); };
        async function loadDB() { const tx = db.transaction(STORE_NAME, "readonly"); const res = await new Promise(r => tx.objectStore(STORE_NAME).get("main").onsuccess = e => r(e.target.result)); if (res) { albums = res.data; renderHome(); } }

        function switchPage(p) { document.querySelectorAll('.page').forEach(v => v.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById(p + 'Page').classList.add('active'); const navId = 'nav' + p.charAt(0).toUpperCase() + p.slice(1); if(document.getElementById(navId)) document.getElementById(navId).classList.add('active'); if(p === 'random') renderRandom(); if(p === 'filter') renderFilterPanels(); }

        document.getElementById('txtInput').onchange = async e => { const text = await e.target.files[0].text(); pathTable = text.split('\n').map(l => { const p = l.split('|').map(s => s.trim()); return p.length >= 3 ? { serial: p[0], actor: p[1], tags: p[2].split(',').map(t => t.trim()) } : null; }).filter(Boolean); alert("✅ Path Synced"); };
        document.getElementById('folderInput').onchange = async e => { const files = e.target.files; const temp = {}; for (let f of files) { if (!f.type.startsWith('image/')) continue; const folder = f.webkitRelativePath.split('/').slice(-2, -1)[0]; const meta = pathTable.find(m => m.serial === folder); if (!meta) continue; if (!temp[folder]) temp[folder] = { ...meta, cat: meta.tags[0], cover: null, contents: [] }; const url = await new Promise(r => { const rd = new FileReader(); rd.onload = ev => r(ev.target.result); rd.readAsDataURL(f); }); if (f.name.includes('封面')) temp[folder].cover = {url}; else temp[folder].contents.push({url}); } albums = temp; db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME).put({id:"main", data:albums}); renderHome(); switchPage('home'); };

        function renderHome() { const list = Object.values(albums); if(!list.length) return; const r = list[Math.floor(Math.random()*list.length)]; document.getElementById('heroBlurBg').style.backgroundImage = `url(${r.cover?.url})`; document.getElementById('heroMainImg').src = r.cover?.url; document.getElementById('heroTitle').innerText = r.serial; document.getElementById('heroInfoBtn').onclick = () => openDetail(r.serial); const cats = {}; list.forEach(v => { (cats[v.cat] = cats[v.cat] || []).push(v); }); document.getElementById('mainRows').innerHTML = Object.keys(cats).map(c => `<section><h2 class="px-6 text-[10px] font-black text-zinc-500 mb-4 tracking-[0.3em] uppercase">${c}</h2><div class="row-container no-scrollbar">${cats[c].map(x => `<div onclick="openDetail('${x.serial}')" class="flex-shrink-0 w-44 aspect-video bg-zinc-900 rounded-xl overflow-hidden shadow-lg"><img src="${x.cover?.url}" class="w-full h-full object-cover"></div>`).join('')}</div></section>`).join(''); }
        function toggleCollapse(id) { document.getElementById(id).classList.toggle('open'); }
        function renderFilterPanels() { const list = Object.values(albums); const actors = [...new Set(list.map(a => a.actor))]; const tags = [...new Set(list.flatMap(a => a.tags))]; document.getElementById('actorList').innerHTML = actors.map(a => `<div class="chip" onclick="filterBy('actor', '${a}', this)">${a}</div>`).join(''); document.getElementById('tagList').innerHTML = tags.map(t => `<div class="chip" onclick="filterBy('tag', '${t}', this)"># ${t}</div>`).join(''); if(list.length > 0) filterBy('all', '', null); }
        function filterBy(type, val, el) { if(el) { document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); } const list = Object.values(albums); const res = type === 'all' ? list : list.filter(i => type === 'actor' ? i.actor === val : i.tags.includes(val)); document.getElementById('filterResults').innerHTML = res.map(x => `<div onclick="openDetail('${x.serial}')" class="aspect-video bg-zinc-900 rounded-xl overflow-hidden shadow-md"><img src="${x.cover?.url}" class="w-full h-full object-cover"></div>`).join(''); }

        // --- 隨機頁面渲染 (堆疊資訊 + 加大 i 圖示) ---
        function renderRandom() {
            const list = Object.values(albums).sort(() => Math.random() - 0.5);
            document.getElementById('randomPage').innerHTML = list.map(item => {
                const photos = [...item.contents].sort(() => Math.random() - 0.5);
                if(photos.length === 0 && item.cover) photos.push(item.cover);
                randomStates[item.serial] = { index: 0, photos: photos };
                return `
                <div class="tiktok-card">
                    <div class="tiktok-bg" id="rbg-${item.serial}" style="background-image: url(${photos[0].url})"></div>
                    <div class="story-progress">${photos.map((_, i) => `<div class="story-bar"><div class="story-fill" id="pfill-${item.serial}-${i}"></div></div>`).join('')}</div>
                    <img src="${photos[0].url}" id="rimg-${item.serial}" class="relative z-10 max-h-[75vh] max-w-full object-contain" onclick="clickStory(event, '${item.serial}')">
                    
                    <div class="absolute bottom-[110px] left-8 right-8 z-20 pointer-events-none flex justify-between items-end">
                        <div class="flex flex-col gap-0.5">
                            <h3 class="text-2xl font-black italic tracking-tighter drop-shadow-xl text-white">${item.serial}</h3>
                            <p class="text-sm font-bold text-blue-400 drop-shadow-md">${item.actor}</p>
                            <p class="text-[10px] font-medium text-white/40 uppercase tracking-[0.2em]">${item.cat}</p>
                        </div>
                        
                        <div onclick="openDetail('${item.serial}')" class="pointer-events-auto p-4 -mr-4 active:scale-75 transition-all duration-200">
                            <i class="fa-solid fa-circle-info text-3xl text-white/90 drop-shadow-[0_0_15px_rgba(0,0,0,0.8)]"></i>
                        </div>
                    </div>
                </div>`;
            }).join('');
            list.forEach(item => updateStoryUI(item.serial));
        }

        function clickStory(e, s) { const st = randomStates[s]; if (e.clientX < window.innerWidth * 0.3) { if(st.index > 0) st.index--; } else { if(st.index < st.photos.length - 1) st.index++; } updateStoryUI(s); }
        function updateStoryUI(s) { const st = randomStates[s]; if(!st) return; document.getElementById(`rimg-${s}`).src = st.photos[st.index].url; document.getElementById(`rbg-${s}`).style.backgroundImage = `url(${st.photos[st.index].url})`; st.photos.forEach((_, i) => { const f = document.getElementById(`pfill-${s}-${i}`); if(f) f.style.width = i <= st.index ? '100%' : '0%'; }); }

        function openDetail(s) { const item = albums[s]; if(!item) return; document.getElementById('detailHero').style.backgroundImage = `url(${item.cover?.url})`; document.getElementById('detailTitle').innerText = item.serial; document.getElementById('detailActor').innerText = item.actor; document.getElementById('detailPlayLink').href = `https://www.google.com/search?q=${encodeURIComponent(item.serial + ' missav')}`; document.getElementById('detailTags').innerHTML = item.tags.map(t => `<span class="bg-zinc-900 px-3 py-1.5 rounded text-[10px] text-zinc-500 font-bold border border-white/5"># ${t}</span>`).join(''); document.getElementById('episodeGrid').innerHTML = item.contents.map(img => `<div onclick="openLightbox('${img.url}', ${JSON.stringify(item.contents).replace(/"/g, '&quot;')})" class="aspect-video bg-zinc-900 rounded-lg overflow-hidden active:scale-95 transition-transform"><img src="${img.url}" class="w-full h-full object-cover"></div>`).join(''); dv.style.display = 'block'; void dv.offsetWidth; dv.style.transform = 'translateY(0px)'; }
        function closeDetail() { dv.style.transform = 'translateY(100%)'; setTimeout(() => { if(dv.style.transform === 'translateY(100%)') dv.style.display = 'none'; }, 400); }
        function resetDB() { if(confirm("⚠️ This will wipe all local data. Continue?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } }
    </script>
</body>
</html>
